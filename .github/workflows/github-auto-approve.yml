name: Auto Approve Workflow
on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  approve-workflow:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # âœ… Needed to approve workflows
    steps:
      - name: Approve Workflow
        run: |
      - name: Wait for Workflow to Require Approval & Approve It
        run: |
          echo "Waiting for pending workflows..."
          end=$((SECONDS+120))  # Set a 2-minute timeout

          while [ $SECONDS -lt $end ]; do
            run_id=$(gh api repos/${{ github.repository }}/actions/runs \
                      --method GET \
                      --header "Authorization: token ${{ secrets.PAT_TOKEN }}" \
                      --jq '.workflow_runs[] | select(.status=="waiting") | .id' | head -n 1)

            if [ -n "$run_id" ]; then
              echo "Found pending workflow: $run_id. Approving..."
              gh api repos/${{ github.repository }}/actions/runs/$run_id/approve \
                --method POST \
                --header "Authorization: token ${{ secrets.PAT_TOKEN }}"
              echo "Workflow $run_id approved!"
              exit 0
            fi

            echo "No pending workflows yet. Retrying in 5 seconds..."
            sleep 5
          done

          echo "Timeout reached! No workflows required approval."
          exit 1
        env:
          GH_TOKEN: ${{ secrets.PAT }}
